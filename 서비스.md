# NestJS Q&A 플랫폼 서비스 아키텍처

## 시스템 개요
Stack Overflow와 유사한 질문-답변 플랫폼으로, 사용자 인증, 질문 관리, 답변 관리 기능을 제공합니다.

## 아키텍처 다이어그램

### 전체 시스템 구조
```mermaid
graph TB
    subgraph "Client Layer"
        Client[Web Client]
    end
    
    subgraph "API Gateway"
        Express[Express Server]
        Session[Session Management]
    end
    
    subgraph "Application Layer"
        AppModule[App Module]
        
        subgraph "Auth Module"
            LoginController[Login Controller]
            RegisterController[Register Controller]
            LoginService[Login Service]
            RegisterService[Register Service]
        end
        
        subgraph "Question Module"
            QuestionController[Question Controller]
            AnswerController[Answer Controller]
            QuestionService[Question Service]
            AnswerService[Answer Service]
        end
        
        subgraph "Database Module"
            MigrationController[Migration Controller]
            DatabaseService[Database Service]
            TestDataService[Test Data Service]
            MigrationService[Migration Service]
        end
    end
    
    subgraph "Data Layer"
        MySQL[(MySQL Database)]
        
        subgraph "Entities"
            UserEntity[User Entity]
            QuestionEntity[Question Entity]
            AnswerEntity[Answer Entity]
        end
    end
    
    Client --> Express
    Express --> Session
    Express --> AppModule
    
    AppModule --> LoginController
    AppModule --> RegisterController
    AppModule --> QuestionController
    AppModule --> AnswerController
    AppModule --> MigrationController
    
    LoginController --> LoginService
    RegisterController --> RegisterService
    QuestionController --> QuestionService
    AnswerController --> AnswerService
    MigrationController --> DatabaseService
    MigrationController --> MigrationService
    
    LoginService --> UserEntity
    RegisterService --> UserEntity
    QuestionService --> QuestionEntity
    QuestionService --> UserEntity
    AnswerService --> AnswerEntity
    AnswerService --> QuestionEntity
    AnswerService --> UserEntity
    
    UserEntity --> MySQL
    QuestionEntity --> MySQL
    AnswerEntity --> MySQL
```

### 데이터베이스 관계도
```mermaid
erDiagram
    User {
        int mbrId PK
        string userId UK
        string password
        string name
        string email
        string phone
        enum role
        string image
        int reputation
        datetime createdAt
        datetime updatedAt
    }
    
    Question {
        int id PK
        string title
        text description
        int votes
        int answers
        int views
        json tags
        int userId FK
        datetime createdAt
        datetime updatedAt
    }
    
    Answer {
        int id PK
        text content
        int votes
        boolean accepted
        int questionId FK
        int userId FK
        datetime createdAt
        datetime updatedAt
    }
    
    User ||--o{ Question : "작성"
    User ||--o{ Answer : "작성"
    Question ||--o{ Answer : "포함"
```

### API 엔드포인트 구조
```mermaid
graph LR
    subgraph "Authentication APIs"
        A1[POST /login/loginProcess]
        A2[POST /register/CheckId]
        A3[POST /register/registerProcess]
    end
    
    subgraph "Question APIs"
        Q1[GET /questions]
        Q2[POST /questions]
        Q3[GET /questions/:id]
        Q4[PATCH /questions/:id]
        Q5[DELETE /questions/:id]
        Q6[POST /questions/:id/vote]
    end
    
    subgraph "Answer APIs"
        AN1[GET /questions/:questionId/answers]
        AN2[POST /questions/:questionId/answers]
        AN3[GET /questions/:questionId/answers/:id]
        AN4[PATCH /questions/:questionId/answers/:id]
        AN5[DELETE /questions/:questionId/answers/:id]
        AN6[POST /questions/:questionId/answers/:id/vote]
        AN7[POST /questions/:questionId/answers/:id/accept]
    end
    
    subgraph "Migration APIs"
        M1[POST /migration/seed]
        M2[POST /migration/test]
        M3[GET /migration/validate-users]
        M4[POST /migration/full-test]
        M5[GET /migration/migrations]
    end
```

### 서비스 플로우
```mermaid
sequenceDiagram
    participant C as Client
    participant LC as Login Controller
    participant LS as Login Service
    participant QC as Question Controller
    participant QS as Question Service
    participant AC as Answer Controller
    participant AS as Answer Service
    participant DB as Database
    
    Note over C,DB: 사용자 로그인 플로우
    C->>LC: POST /login/loginProcess
    LC->>LS: processLogin(loginDto)
    LS->>DB: 사용자 인증 확인
    DB-->>LS: 인증 결과
    LS-->>LC: 로그인 결과
    LC-->>C: 세션 ID 반환
    
    Note over C,DB: 질문 생성 플로우
    C->>QC: POST /questions
    QC->>QS: create(createQuestionDto, userId)
    QS->>DB: 질문 저장
    DB-->>QS: 저장된 질문
    QS-->>QC: QuestionResponseDto
    QC-->>C: 생성된 질문 정보
    
    Note over C,DB: 답변 생성 플로우
    C->>AC: POST /questions/:questionId/answers
    AC->>AS: create(questionId, createAnswerDto, userId)
    AS->>DB: 답변 저장
    AS->>DB: 질문의 답변 수 업데이트
    DB-->>AS: 저장된 답변
    AS-->>AC: AnswerResponseDto
    AC-->>C: 생성된 답변 정보
```

### 보안 및 인증 구조
```mermaid
graph TB
    subgraph "인증 시스템"
        SessionStore[Session Store]
        BcryptHash[Bcrypt Password Hash]
        
        subgraph "인증 플로우"
            LoginCheck[로그인 확인]
            PasswordVerify[비밀번호 검증]
            SessionCreate[세션 생성]
        end
        
        subgraph "인가 시스템"
            RoleCheck[역할 기반 접근 제어]
            OwnershipCheck[소유권 확인]
        end
    end
    
    LoginCheck --> PasswordVerify
    PasswordVerify --> BcryptHash
    PasswordVerify --> SessionCreate
    SessionCreate --> SessionStore
    
    SessionStore --> RoleCheck
    SessionStore --> OwnershipCheck
```

## 주요 기능

### 1. 사용자 관리
- **회원가입**: 아이디 중복 확인, 비밀번호 암호화
- **로그인**: 세션 기반 인증
- **사용자 역할**: USER, ADMIN 구분
- **평판 시스템**: 활동에 따른 평판 점수

### 2. 질문 관리
- **질문 CRUD**: 생성, 조회, 수정, 삭제
- **투표 시스템**: 질문에 대한 추천/비추천
- **태그 시스템**: JSON 형태의 태그 저장
- **조회수 추적**: 질문 조회 시 자동 증가

### 3. 답변 관리
- **답변 CRUD**: 생성, 조회, 수정, 삭제
- **답변 투표**: 답변에 대한 추천/비추천
- **답변 채택**: 질문 작성자가 최적 답변 선택
- **중첩 구조**: 질문-답변 관계 유지

### 4. 데이터베이스 관리
- **Migration 시스템**: TypeORM 기반 스키마 관리
- **테스트 데이터**: 개발/테스트용 샘플 데이터
- **데이터 유효성 검증**: 데이터 무결성 확인

## 기술 스택

### Backend
- **Framework**: NestJS
- **Database**: MySQL
- **ORM**: TypeORM
- **Authentication**: express-session
- **Password**: bcrypt
- **Validation**: class-validator, class-transformer

### 개발 도구
- **Language**: TypeScript
- **Build**: SWC
- **Testing**: Jest
- **Linting**: ESLint + Prettier
- **Migration**: TypeORM CLI

## 배포 및 운영

### 환경 설정
```bash
# 데이터베이스 초기화
npm run db:init

# 개발 서버 실행
npm run start:dev

# 테스트 데이터 생성
npm run db:seed
```

### 주요 환경 변수
- `DB_HOST`: 데이터베이스 호스트
- `DB_PORT`: 데이터베이스 포트
- `DB_USERNAME`: 데이터베이스 사용자명
- `DB_PASSWORD`: 데이터베이스 비밀번호
- `DB_NAME`: 데이터베이스 이름